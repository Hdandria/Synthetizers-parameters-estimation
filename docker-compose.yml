version: '3.8'

services:
  flow-multi-experiments:
    build: .
    image: synth-param-estimation:latest
    user: trainer
    working_dir: /workspace
    environment:
      - PROJECT_ROOT=/workspace
      - PYTHONUNBUFFERED=1
      - HYDRA_FULL_ERROR=1
      - WANDB_API_KEY=${WANDB_API_KEY}
      - S3_BUCKET=${S3_BUCKET}
      - S3_PLUGIN_PATH=${S3_PLUGIN_PATH}
    env_file:
      - .env
    volumes:
      - ./outputs:/workspace/outputs
      - ./logs:/workspace/logs
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    command: >
      bash -c "
        echo 'Starting flow_multi experiments...' &&
        python src/train.py experiment=flow_multi/base_full paths=docker
      "
    restart: unless-stopped